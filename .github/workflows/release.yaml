name: Release

on:
  push:
    # On Tag / Release by Mask
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    name: Build
    uses: ./.github/workflows/build.yaml
  
  release:
    name: Release
    needs:
      - build
    permissions:
      contents: write
    
    runs-on: ubuntu-latest
    
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: SvitloBot
          path: release-files

      - name: Check artifacts
        run: |
          ls -l
        working-directory: release-files

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release-files/*/*.*

  publish:
    name: Publish new firmware and website to GitHub Pages
    runs-on: ubuntu-latest
    needs: 
      - build
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: SvitloBot
          path: release-files

      - name: Copy artifacts files
        run: |
          mkdir output
          cp -R release-files/*/* output/

      - name: Copy website files
        run: cp -R static/* output/

      - name: Check output
        run: |
          ls -l
        working-directory: output

      - name: Deploy
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: svitlobot
          folder: output
          clean: true

  ci-status:
    name: Status
    runs-on: ubuntu-latest
    needs:
      - build
      - release
      - publish
    if: always()
    steps:
      - name: Success
        if: ${{ !(contains(needs.*.result, 'failure')) }}
        run: exit 0
      - name: Failure
        if: ${{ contains(needs.*.result, 'failure') }}
        run: exit 1
